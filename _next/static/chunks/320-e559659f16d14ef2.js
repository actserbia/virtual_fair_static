"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[320],{5320:function(t,e,n){let r,i,o,s;n.d(e,{u:function(){return tg}});var a=n(3428),l=n(7890),u=n(2265),c=n(6375);let d=2,f=new c.Vector3,p=new c.Vector3,h=new c.Vector3,y=new c.Vector2,m=new c.Vector2,x=new c.Vector2,g=new c.Vector3;function w(t,e,n,r,i){let o=3*r,s=t.index.getX(o),a=t.index.getX(o+1),l=t.index.getX(o+2),u=function(t,e,n,r,i,o,s){f.fromBufferAttribute(e,r),p.fromBufferAttribute(e,i),h.fromBufferAttribute(e,o);let a=null===(s===c.BackSide?t.intersectTriangle(h,p,f,!0,g):t.intersectTriangle(f,p,h,s!==c.DoubleSide,g))?null:{distance:t.origin.distanceTo(g),point:g.clone()};if(a){n&&(y.fromBufferAttribute(n,r),m.fromBufferAttribute(n,i),x.fromBufferAttribute(n,o),a.uv=c.Triangle.getUV(g,f,p,h,y,m,x,new c.Vector2));let t={a:r,b:i,c:o,normal:new c.Vector3,materialIndex:0};c.Triangle.getNormal(f,p,h,t.normal),a.face=t,a.faceIndex=r}return a}(n,t.attributes.position,t.attributes.uv,s,a,l,e);return u?(u.faceIndex=r,i&&i.push(u),u):null}function B(t,e,n){return null===t?null:(t.point.applyMatrix4(e.matrixWorld),t.distance=t.point.distanceTo(n.ray.origin),t.object=e,t.distance<n.near||t.distance>n.far)?null:t}class b{constructor(){}}function T(t,e,n){return n.min.x=e[t],n.min.y=e[t+1],n.min.z=e[t+2],n.max.x=e[t+3],n.max.y=e[t+4],n.max.z=e[t+5],n}function P(t){let e=-1,n=-1/0;for(let r=0;r<3;r++){let i=t[r+3]-t[r];i>n&&(n=i,e=r)}return e}function A(t,e,n){let r,i;for(let o=0;o<3;o++){let s=o+3;r=t[o],i=e[o],n[o]=r<i?r:i,r=t[s],i=e[s],n[s]=r>i?r:i}}function V(t,e,n){for(let r=0;r<3;r++){let i=e[t+2*r],o=e[t+2*r+1],s=i-o,a=i+o;s<n[r]&&(n[r]=s),a>n[r+3]&&(n[r+3]=a)}}function M(t){let e=t[3]-t[0],n=t[4]-t[1],r=t[5]-t[2];return 2*(e*n+n*r+r*e)}function v(t,e,n,r,i=null){let o=1/0,s=1/0,a=1/0,l=-1/0,u=-1/0,c=-1/0,d=1/0,f=1/0,p=1/0,h=-1/0,y=-1/0,m=-1/0,x=null!==i;for(let r=6*e,i=(e+n)*6;r<i;r+=6){let e=t[r+0],n=t[r+1],i=e-n,g=e+n;i<o&&(o=i),g>l&&(l=g),x&&e<d&&(d=e),x&&e>h&&(h=e);let w=t[r+2],B=t[r+3],b=w-B,T=w+B;b<s&&(s=b),T>u&&(u=T),x&&w<f&&(f=w),x&&w>y&&(y=w);let P=t[r+4],A=t[r+5],V=P-A,M=P+A;V<a&&(a=V),M>c&&(c=M),x&&P<p&&(p=P),x&&P>m&&(m=P)}r[0]=o,r[1]=s,r[2]=a,r[3]=l,r[4]=u,r[5]=c,x&&(i[0]=d,i[1]=f,i[2]=p,i[3]=h,i[4]=y,i[5]=m)}let S=(t,e)=>t.candidate-e.candidate,F=Array(32).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),U=new Float32Array(6);class z{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let n=1/0,r=-1/0;for(let i=0,o=t.length;i<o;i++){let o=t[i][e];n=o<n?o:n,r=o>r?o:r}this.min=n,this.max=r}setFromPoints(t,e){let n=1/0,r=-1/0;for(let i=0,o=e.length;i<o;i++){let o=e[i],s=t.dot(o);n=s<n?s:n,r=s>r?s:r}this.min=n,this.max=r}isSeparated(t){return this.min>t.max||t.min>this.max}}z.prototype.setFromBox=function(){let t=new c.Vector3;return function(e,n){let r=n.min,i=n.max,o=1/0,s=-1/0;for(let n=0;n<=1;n++)for(let a=0;a<=1;a++)for(let l=0;l<=1;l++){t.x=r.x*n+i.x*(1-n),t.y=r.y*a+i.y*(1-a),t.z=r.z*l+i.z*(1-l);let u=e.dot(t);o=Math.min(u,o),s=Math.max(u,s)}this.min=o,this.max=s}}(),new z;let I=function(){let t=new c.Vector3,e=new c.Vector3,n=new c.Vector3;return function(r,i,o){let s,a;let l=r.start,u=i.start;n.subVectors(l,u),t.subVectors(r.end,r.start),e.subVectors(i.end,i.start);let c=n.dot(e),d=e.dot(t),f=e.dot(e),p=n.dot(t),h=t.dot(t)*f-d*d;s=0!==h?(c*d-p*f)/h:0,a=(c+s*d)/f,o.x=s,o.y=a}}(),q=function(){let t=new c.Vector2,e=new c.Vector3,n=new c.Vector3;return function(r,i,o,s){I(r,i,t);let a=t.x,l=t.y;if(a>=0&&a<=1&&l>=0&&l<=1){r.at(a,o),i.at(l,s);return}if(a>=0&&a<=1){l<0?i.at(0,s):i.at(1,s),r.closestPointToPoint(s,!0,o);return}if(l>=0&&l<=1){a<0?r.at(0,o):r.at(1,o),i.closestPointToPoint(o,!0,s);return}{let t,u;if(t=a<0?r.start:r.end,u=l<0?i.start:i.end,r.closestPointToPoint(u,!0,e),i.closestPointToPoint(t,!0,n),e.distanceToSquared(u)<=n.distanceToSquared(t)){o.copy(e),s.copy(u);return}o.copy(t),s.copy(n);return}}}(),_=function(){let t=new c.Vector3,e=new c.Vector3,n=new c.Plane,r=new c.Line3;return function(i,o){let{radius:s,center:a}=i,{a:l,b:u,c}=o;if(r.start=l,r.end=u,r.closestPointToPoint(a,!0,t).distanceTo(a)<=s||(r.start=l,r.end=c,r.closestPointToPoint(a,!0,t).distanceTo(a)<=s)||(r.start=u,r.end=c,r.closestPointToPoint(a,!0,t).distanceTo(a)<=s))return!0;let d=o.getPlane(n);if(Math.abs(d.distanceToPoint(a))<=s){let t=d.projectPoint(a,e);if(o.containsPoint(t))return!0}return!1}}();function C(t){return 1e-15>Math.abs(t)}class k extends c.Triangle{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=[,,,,].fill().map(()=>new c.Vector3),this.satBounds=[,,,,].fill().map(()=>new z),this.points=[this.a,this.b,this.c],this.sphere=new c.Sphere,this.plane=new c.Plane,this.needsUpdate=!0}intersectsSphere(t){return _(t,this)}update(){let t=this.a,e=this.b,n=this.c,r=this.points,i=this.satAxes,o=this.satBounds,s=i[0],a=o[0];this.getNormal(s),a.setFromPoints(s,r);let l=i[1],u=o[1];l.subVectors(t,e),u.setFromPoints(l,r);let c=i[2],d=o[2];c.subVectors(e,n),d.setFromPoints(c,r);let f=i[3],p=o[3];f.subVectors(n,t),p.setFromPoints(f,r),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(s,t),this.needsUpdate=!1}}k.prototype.closestPointToSegment=function(){let t=new c.Vector3,e=new c.Vector3,n=new c.Line3;return function(r,i=null,o=null){let s;let{start:a,end:l}=r,u=this.points,c=1/0;for(let a=0;a<3;a++){let l=(a+1)%3;n.start.copy(u[a]),n.end.copy(u[l]),q(n,r,t,e),(s=t.distanceToSquared(e))<c&&(c=s,i&&i.copy(t),o&&o.copy(e))}return this.closestPointToPoint(a,t),(s=a.distanceToSquared(t))<c&&(c=s,i&&i.copy(t),o&&o.copy(a)),this.closestPointToPoint(l,t),(s=l.distanceToSquared(t))<c&&(c=s,i&&i.copy(t),o&&o.copy(l)),Math.sqrt(c)}}(),k.prototype.intersectsTriangle=function(){let t=new k,e=[,,,],n=[,,,],r=new z,i=new z,o=new c.Vector3,s=new c.Vector3,a=new c.Vector3,l=new c.Vector3,u=new c.Line3,d=new c.Line3,f=new c.Line3;return function(c,p=null,h=!1){this.needsUpdate&&this.update(),c.isExtendedTriangle?c.needsUpdate&&c.update():(t.copy(c),t.update(),c=t);let y=this.plane,m=c.plane;if(Math.abs(y.normal.dot(m.normal))>1-1e-10){let t=this.satBounds,s=this.satAxes;n[0]=c.a,n[1]=c.b,n[2]=c.c;for(let e=0;e<4;e++){let i=t[e],o=s[e];if(r.setFromPoints(o,n),i.isSeparated(r))return!1}let a=c.satBounds,l=c.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let t=0;t<4;t++){let n=a[t],i=l[t];if(r.setFromPoints(i,e),n.isSeparated(r))return!1}for(let t=0;t<4;t++){let a=s[t];for(let t=0;t<4;t++){let s=l[t];if(o.crossVectors(a,s),r.setFromPoints(o,e),i.setFromPoints(o,n),r.isSeparated(i))return!1}}return p&&(h||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),p.start.set(0,0,0),p.end.set(0,0,0)),!0}{let t=this.points,e=!1,n=0;for(let r=0;r<3;r++){let i=t[r],o=t[(r+1)%3];u.start.copy(i),u.end.copy(o),u.delta(s);let a=e?d.start:d.end,l=C(m.distanceToPoint(i));if(C(m.normal.dot(s))&&l){d.copy(u),n=2;break}if((m.intersectLine(u,a)||l)&&!C(a.distanceTo(o))){if(n++,e)break;e=!0}}if(1===n&&c.containsPoint(d.end))return p&&(p.start.copy(d.end),p.end.copy(d.end)),!0;if(2!==n)return!1;let r=c.points,i=!1,o=0;for(let t=0;t<3;t++){let e=r[t],n=r[(t+1)%3];u.start.copy(e),u.end.copy(n),u.delta(a);let s=i?f.start:f.end,l=C(y.distanceToPoint(e));if(C(y.normal.dot(a))&&l){f.copy(u),o=2;break}if((y.intersectLine(u,s)||l)&&!C(s.distanceTo(n))){if(o++,i)break;i=!0}}if(1===o&&this.containsPoint(f.end))return p&&(p.start.copy(f.end),p.end.copy(f.end)),!0;if(2!==o)return!1;if(d.delta(s),f.delta(a),0>s.dot(a)){let t=f.start;f.start=f.end,f.end=t}let h=d.start.dot(s),x=d.end.dot(s),g=f.start.dot(s),w=f.end.dot(s);return(h===w||g===x||x<g!=h<w)&&(p&&(l.subVectors(d.start,f.start),l.dot(s)>0?p.start.copy(d.start):p.start.copy(f.start),l.subVectors(d.end,f.end),0>l.dot(s)?p.end.copy(d.end):p.end.copy(f.end)),!0)}}}(),k.prototype.distanceToPoint=function(){let t=new c.Vector3;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),k.prototype.distanceToTriangle=function(){let t=new c.Vector3,e=new c.Vector3,n=["a","b","c"],r=new c.Line3,i=new c.Line3;return function(o,s=null,a=null){let l=s||a?r:null;if(this.intersectsTriangle(o,l))return(s||a)&&(s&&l.getCenter(s),a&&l.getCenter(a)),0;let u=1/0;for(let e=0;e<3;e++){let r;let i=n[e],l=o[i];this.closestPointToPoint(l,t),(r=l.distanceToSquared(t))<u&&(u=r,s&&s.copy(t),a&&a.copy(l));let c=this[i];o.closestPointToPoint(c,t),(r=c.distanceToSquared(t))<u&&(u=r,s&&s.copy(c),a&&a.copy(t))}for(let l=0;l<3;l++){let c=n[l],d=n[(l+1)%3];r.set(this[c],this[d]);for(let l=0;l<3;l++){let c=n[l],d=n[(l+1)%3];i.set(o[c],o[d]),q(r,i,t,e);let f=t.distanceToSquared(e);f<u&&(u=f,s&&s.copy(t),a&&a.copy(e))}}return Math.sqrt(u)}}();class L{constructor(t,e,n){this.isOrientedBox=!0,this.min=new c.Vector3,this.max=new c.Vector3,this.matrix=new c.Matrix4,this.invMatrix=new c.Matrix4,this.points=Array(8).fill().map(()=>new c.Vector3),this.satAxes=[,,,].fill().map(()=>new c.Vector3),this.satBounds=[,,,].fill().map(()=>new z),this.alignedSatBounds=[,,,].fill().map(()=>new z),this.needsUpdate=!1,t&&this.min.copy(t),e&&this.max.copy(e),n&&this.matrix.copy(n)}set(t,e,n){this.min.copy(t),this.max.copy(e),this.matrix.copy(n),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}function E(t,e,n,r){let i=t.a,o=t.b,s=t.c,a=e,l=e+1,u=e+2;n&&(a=n.getX(e),l=n.getX(e+1),u=n.getX(e+2)),i.x=r.getX(a),i.y=r.getY(a),i.z=r.getZ(a),o.x=r.getX(l),o.y=r.getY(l),o.z=r.getZ(l),s.x=r.getX(u),s.y=r.getY(u),s.z=r.getZ(u)}function H(t,e,n,r,i,o,s){let a=n.index,l=n.attributes.position;for(let n=t,u=e+t;n<u;n++)if(E(s,3*n,a,l),s.needsUpdate=!0,r(s,n,i,o))return!0;return!1}L.prototype.update=function(){let t=this.matrix,e=this.min,n=this.max,r=this.points;for(let i=0;i<=1;i++)for(let o=0;o<=1;o++)for(let s=0;s<=1;s++){let a=r[1*i|2*o|4*s];a.x=i?n.x:e.x,a.y=o?n.y:e.y,a.z=s?n.z:e.z,a.applyMatrix4(t)}let i=this.satBounds,o=this.satAxes,s=r[0];for(let t=0;t<3;t++){let e=o[t],n=i[t],a=r[1<<t];e.subVectors(s,a),n.setFromPoints(e,r)}let a=this.alignedSatBounds;a[0].setFromPointsField(r,"x"),a[1].setFromPointsField(r,"y"),a[2].setFromPointsField(r,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},L.prototype.intersectsBox=function(){let t=new z;return function(e){this.needsUpdate&&this.update();let n=e.min,r=e.max,i=this.satBounds,o=this.satAxes,s=this.alignedSatBounds;if(t.min=n.x,t.max=r.x,s[0].isSeparated(t)||(t.min=n.y,t.max=r.y,s[1].isSeparated(t))||(t.min=n.z,t.max=r.z,s[2].isSeparated(t)))return!1;for(let n=0;n<3;n++){let r=o[n],s=i[n];if(t.setFromBox(r,e),s.isSeparated(t))return!1}return!0}}(),L.prototype.intersectsTriangle=function(){let t=new k,e=[,,,],n=new z,r=new z,i=new c.Vector3;return function(o){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(t.copy(o),t.update(),o=t);let s=this.satBounds,a=this.satAxes;e[0]=o.a,e[1]=o.b,e[2]=o.c;for(let t=0;t<3;t++){let r=s[t],i=a[t];if(n.setFromPoints(i,e),r.isSeparated(n))return!1}let l=o.satBounds,u=o.satAxes,c=this.points;for(let t=0;t<3;t++){let e=l[t],r=u[t];if(n.setFromPoints(r,c),e.isSeparated(n))return!1}for(let t=0;t<3;t++){let o=a[t];for(let t=0;t<4;t++){let s=u[t];if(i.crossVectors(o,s),n.setFromPoints(i,e),r.setFromPoints(i,c),n.isSeparated(r))return!1}}return!0}}(),L.prototype.closestPointToPoint=function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e},L.prototype.distanceToPoint=function(){let t=new c.Vector3;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),L.prototype.distanceToBox=function(){let t=["x","y","z"],e=Array(12).fill().map(()=>new c.Line3),n=Array(12).fill().map(()=>new c.Line3),r=new c.Vector3,i=new c.Vector3;return function(o,s=0,a=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(o))return(a||l)&&(o.getCenter(i),this.closestPointToPoint(i,r),o.closestPointToPoint(r,i),a&&a.copy(r),l&&l.copy(i)),0;let u=s*s,c=o.min,d=o.max,f=this.points,p=1/0;for(let t=0;t<8;t++){let e=f[t];i.copy(e).clamp(c,d);let n=e.distanceToSquared(i);if(n<p&&(p=n,a&&a.copy(e),l&&l.copy(i),n<u))return Math.sqrt(n)}let h=0;for(let r=0;r<3;r++)for(let i=0;i<=1;i++)for(let o=0;o<=1;o++){let s=(r+1)%3,a=(r+2)%3,l=i<<s|o<<a,u=1<<r|i<<s|o<<a,p=f[l],y=f[u];e[h].set(p,y);let m=t[r],x=t[s],g=t[a],w=n[h],B=w.start,b=w.end;B[m]=c[m],B[x]=i?c[x]:d[x],B[g]=o?c[g]:d[x],b[m]=d[m],b[x]=i?c[x]:d[x],b[g]=o?c[g]:d[x],h++}for(let t=0;t<=1;t++)for(let e=0;e<=1;e++)for(let n=0;n<=1;n++){i.x=t?d.x:c.x,i.y=e?d.y:c.y,i.z=n?d.z:c.z,this.closestPointToPoint(i,r);let o=i.distanceToSquared(r);if(o<p&&(p=o,a&&a.copy(r),l&&l.copy(i),o<u))return Math.sqrt(o)}for(let t=0;t<12;t++){let o=e[t];for(let t=0;t<12;t++){q(o,n[t],r,i);let e=r.distanceToSquared(i);if(e<p&&(p=e,a&&a.copy(r),l&&l.copy(i),e<u))return Math.sqrt(e)}}return Math.sqrt(p)}}();class D{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){let t=this._primitives;return 0===t.length?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}function X(t,e){return 65535===e[t+15]}let O=new c.Box3,R=new c.Vector3,N=["x","y","z"],Z=function(){let t,e;let n=[],r=new D(()=>new c.Box3);return function(...a){t=r.getPrimitive(),e=r.getPrimitive(),n.push(t,e);let l=function n(r,a,l,u,c=null,d=0,f=0){function p(t){let e=2*t,n=o,r=s;for(;!X(e,n);)t+=8,e=2*t;return r[t+6]}function h(t){let e=2*t,n=o,r=s;for(;!X(e,n);)e=2*(t=r[t+6]);return r[t+6]+n[e+14]}let y=2*r,m=i,x=o,g=s;if(X(y,x)){let e=g[r+6],n=x[y+14];return T(r,m,t),u(e,n,!1,f,d+r,t)}{let i,o,s,y,w,B;let b=r+8,P=g[r+6],A=b,V=P;if(c&&(s=t,y=e,T(A,m,s),T(V,m,y),i=c(s),(o=c(y))<i)){A=P,V=b;let t=i;i=o,o=t,s=y}s||T(A,m,s=t);let M=l(s,X(2*A,x),i,f+1,d+A);if(2===M){let t=p(A);w=u(t,h(A)-t,!0,f+1,d+A,s)}else w=M&&n(A,a,l,u,c,d,f+1);if(w)return!0;T(V,m,y=e);let v=l(y,X(2*V,x),o,f+1,d+V);if(2===v){let t=p(V);B=u(t,h(V)-t,!0,f+1,d+V,y)}else B=v&&n(V,a,l,u,c,d,f+1);return!!B}}(...a);r.releasePrimitive(t),r.releasePrimitive(e),n.pop(),n.pop();let u=n.length;return u>0&&(e=n[u-1],t=n[u-2]),l}}(),G=function(){let t=new k,e=new k,n=new c.Matrix4,r=new L,a=new L;return function l(u,c,d,f,p=null){let h=2*u,y=i,m=o,x=s;if(null===p&&(d.boundingBox||d.computeBoundingBox(),r.set(d.boundingBox.min,d.boundingBox.max,f),p=r),X(h,m)){let r=c.index,i=c.attributes.position,o=d.index,s=d.attributes.position,l=x[u+6],p=m[h+14];if(n.copy(f).invert(),d.boundsTree)return T(u,y,a),a.matrix.copy(n),a.needsUpdate=!0,d.boundsTree.shapecast({intersectsBounds:t=>a.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(f),t.b.applyMatrix4(f),t.c.applyMatrix4(f),t.needsUpdate=!0;for(let n=3*l,o=(p+l)*3;n<o;n+=3)if(E(e,n,r,i),e.needsUpdate=!0,t.intersectsTriangle(e))return!0;return!1}});for(let a=3*l,u=p+3*l;a<u;a+=3){E(t,a,r,i),t.a.applyMatrix4(n),t.b.applyMatrix4(n),t.c.applyMatrix4(n),t.needsUpdate=!0;for(let n=0,r=o.count;n<r;n+=3)if(E(e,n,o,s),e.needsUpdate=!0,t.intersectsTriangle(e))return!0}}else{let t=u+8,e=x[u+6];return T(t,y,O),!!(p.intersectsBox(O)&&l(t,c,d,f,p))||(T(e,y,O),!!(p.intersectsBox(O)&&l(e,c,d,f,p)))}}}();function Y(t,e,n,r){return T(t,e,O),n.intersectBox(O,r)}let j=[];function W(t){r&&j.push(r),r=t,i=new Float32Array(t),o=new Uint16Array(t),s=new Uint32Array(t)}function $(){r=null,i=null,o=null,s=null,j.length&&W(j.pop())}let J=Symbol("skip tree generation"),K=new c.Box3,Q=new c.Box3,tt=new c.Matrix4,te=new L,tn=new L,tr=new c.Vector3,ti=new c.Vector3,to=new c.Vector3,ts=new c.Vector3,ta=new c.Vector3,tl=new c.Box3,tu=new D(()=>new k);class tc{static serialize(t,e={}){if(e.isBufferGeometry)return console.warn("MeshBVH.serialize: The arguments for the function have changed. See documentation for new signature."),tc.serialize(arguments[0],{cloneBuffers:void 0===arguments[2]||arguments[2]});e={cloneBuffers:!0,...e};let n=t.geometry,r=t._roots,i=n.getIndex();return e.cloneBuffers?{roots:r.map(t=>t.slice()),index:i.array.slice()}:{roots:r,index:i.array}}static deserialize(t,e,n={}){if("boolean"==typeof n)return console.warn("MeshBVH.deserialize: The arguments for the function have changed. See documentation for new signature."),tc.deserialize(arguments[0],arguments[1],{setIndex:void 0===arguments[2]||arguments[2]});n={setIndex:!0,...n};let{index:r,roots:i}=t,o=new tc(e,{...n,[J]:!0});if(o._roots=i,n.setIndex){let n=e.getIndex();if(null===n){let n=new c.BufferAttribute(t.index,1,!1);e.setIndex(n)}else n.array!==r&&(n.array.set(r),n.needsUpdate=!0)}return o}constructor(t,e={}){if(t.isBufferGeometry){if(t.index&&t.index.isInterleavedBufferAttribute)throw Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw Error("MeshBVH: Only BufferGeometries are supported.");if((e=Object.assign({strategy:0,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,[J]:!1},e)).useSharedArrayBuffer&&"undefined"==typeof SharedArrayBuffer)throw Error("MeshBVH: SharedArrayBuffer is not available.");this._roots=null,e[J]||(this._roots=function(t,e){let n,r,i;let o=function(t,e){function n(t){h&&h(t/y)}function r(e,i,c,h=null,y=0){if(!m&&y>=l&&(m=!0,u&&(console.warn(`MeshBVH: Max depth of ${l} reached when generating BVH. Consider increasing maxDepth.`),console.warn(t))),c<=f||y>=l)return n(i+c),e.offset=i,e.count=c,e;let x=function(t,e,n,r,i,o){let s=-1,a=0;if(0===o)-1!==(s=P(e))&&(a=(e[s]+e[s+3])/2);else if(1===o)-1!==(s=P(t))&&(a=function(t,e,n,r){let i=0;for(let o=e,s=e+n;o<s;o++)i+=t[6*o+2*r];return i/n}(n,r,i,s));else if(o===d){let o=M(t),l=1.25*i,u=6*r,c=(r+i)*6;for(let t=0;t<3;t++){let r=e[t],d=(e[t+3]-r)/32;if(i<8){let e=[...F];e.length=i;let r=0;for(let i=u;i<c;i+=6,r++){let o=e[r];o.candidate=n[i+2*t],o.count=0;let{bounds:s,leftCacheBounds:a,rightCacheBounds:l}=o;for(let t=0;t<3;t++)l[t]=1/0,l[t+3]=-1/0,a[t]=1/0,a[t+3]=-1/0,s[t]=1/0,s[t+3]=-1/0;V(i,n,s)}e.sort(S);let d=i;for(let t=0;t<d;t++){let n=e[t];for(;t+1<d&&e[t+1].candidate===n.candidate;)e.splice(t+1,1),d--}for(let r=u;r<c;r+=6){let i=n[r+2*t];for(let t=0;t<d;t++){let o=e[t];i>=o.candidate?V(r,n,o.rightCacheBounds):(V(r,n,o.leftCacheBounds),o.count++)}}for(let n=0;n<d;n++){let r=e[n],u=r.count,c=i-r.count,d=r.leftCacheBounds,f=r.rightCacheBounds,p=0;0!==u&&(p=M(d)/o);let h=0;0!==c&&(h=M(f)/o);let y=1+1.25*(p*u+h*c);y<l&&(s=t,l=y,a=r.candidate)}}else{for(let t=0;t<32;t++){let e=F[t];e.count=0,e.candidate=r+d+t*d;let n=e.bounds;for(let t=0;t<3;t++)n[t]=1/0,n[t+3]=-1/0}for(let e=u;e<c;e+=6){let i=~~((n[e+2*t]-r)/d);i>=32&&(i=31);let o=F[i];o.count++,V(e,n,o.bounds)}let e=F[31];!function(t,e){e.set(t)}(e.bounds,e.rightCacheBounds);for(let t=30;t>=0;t--){let e=F[t],n=F[t+1];A(e.bounds,n.rightCacheBounds,e.rightCacheBounds)}let f=0;for(let e=0;e<31;e++){let n=F[e],r=n.count,u=n.bounds,c=F[e+1].rightCacheBounds;0!==r&&(0===f?function(t,e){e.set(t)}(u,U):A(u,U,U));let d=0,p=0;0!==(f+=r)&&(d=M(U)/o);let h=i-f;0!==h&&(p=M(c)/o);let y=1+1.25*(d*f+p*h);y<l&&(s=t,l=y,a=n.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${o} used.`);return{axis:s,pos:a}}(e.boundingData,h,s,i,c,p);if(-1===x.axis)return n(i+c),e.offset=i,e.count=c,e;let g=function(t,e,n,r,i){let o=n,s=n+r-1,a=i.pos,l=2*i.axis;for(;;){for(;o<=s&&e[6*o+l]<a;)o++;for(;o<=s&&e[6*s+l]>=a;)s--;if(!(o<s))return o;for(let n=0;n<3;n++){let r=t[3*o+n];t[3*o+n]=t[3*s+n],t[3*s+n]=r;let i=e[6*o+2*n+0];e[6*o+2*n+0]=e[6*s+2*n+0],e[6*s+2*n+0]=i;let a=e[6*o+2*n+1];e[6*o+2*n+1]=e[6*s+2*n+1],e[6*s+2*n+1]=a}o++,s--}}(a,s,i,c,x);if(g===i||g===i+c)n(i+c),e.offset=i,e.count=c;else{e.splitAxis=x.axis;let t=new b,n=g-i;e.left=t,t.boundingData=new Float32Array(6),v(s,i,n,t.boundingData,o),r(t,i,n,o,y+1);let a=new b,l=c-n;e.right=a,a.boundingData=new Float32Array(6),v(s,g,l,a.boundingData,o),r(a,g,l,o,y+1)}return e}!function(t,e){if(!t.index){let n;let r=t.attributes.position.count,i=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;n=r>65535?new Uint32Array(new i(4*r)):new Uint16Array(new i(2*r)),t.setIndex(new c.BufferAttribute(n,1));for(let t=0;t<r;t++)n[t]=t}}(t,e);let i=new Float32Array(6),o=new Float32Array(6),s=function(t,e){let n=t.attributes.position,r=t.index.array,i=r.length/3,o=new Float32Array(6*i),s=n.normalized,a=n.array,l=n.offset||0,u=3;n.isInterleavedBufferAttribute&&(u=n.data.stride);let c=["getX","getY","getZ"];for(let t=0;t<i;t++){let i,d,f;let p=3*t,h=6*t;s?(i=r[p+0],d=r[p+1],f=r[p+2]):(i=r[p+0]*u+l,d=r[p+1]*u+l,f=r[p+2]*u+l);for(let t=0;t<3;t++){let r,l,u;s?(r=n[c[t]](i),l=n[c[t]](d),u=n[c[t]](f)):(r=a[i+t],l=a[d+t],u=a[f+t]);let p=r;l<p&&(p=l),u<p&&(p=u);let y=r;l>y&&(y=l),u>y&&(y=u);let m=(y-p)/2,x=2*t;o[h+x+0]=p+m,o[h+x+1]=m+(Math.abs(p)+m)*5960464477539063e-23,p<e[t]&&(e[t]=p),y>e[t+3]&&(e[t+3]=y)}}return o}(t,i),a=t.index.array,l=e.maxDepth,u=e.verbose,f=e.maxLeafTris,p=e.strategy,h=e.onProgress,y=t.index.count/3,m=!1,x=[],g=function(t){if(!t.groups||!t.groups.length)return[{offset:0,count:t.index.count/3}];let e=[],n=new Set;for(let e of t.groups)n.add(e.start),n.add(e.start+e.count);let r=Array.from(n.values()).sort((t,e)=>t-e);for(let t=0;t<r.length-1;t++){let n=r[t],i=r[t+1];e.push({offset:n/3,count:(i-n)/3})}return e}(t);if(1===g.length){let t=g[0],e=new b;e.boundingData=i,function(t,e,n,r){let i=1/0,o=1/0,s=1/0,a=-1/0,l=-1/0,u=-1/0;for(let r=6*e,c=(e+n)*6;r<c;r+=6){let e=t[r+0];e<i&&(i=e),e>a&&(a=e);let n=t[r+2];n<o&&(o=n),n>l&&(l=n);let c=t[r+4];c<s&&(s=c),c>u&&(u=c)}r[0]=i,r[1]=o,r[2]=s,r[3]=a,r[4]=l,r[5]=u}(s,t.offset,t.count,o),r(e,t.offset,t.count,o),x.push(e)}else for(let t of g){let e=new b;e.boundingData=new Float32Array(6),v(s,t.offset,t.count,e.boundingData,o),r(e,t.offset,t.count,o),x.push(e)}return x}(t,e),s=[],a=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let t=0;t<o.length;t++){let e=o[t],l=new a(32*function t(e){return e.count?1:1+t(e.left)+t(e.right)}(e));n=new Float32Array(l),r=new Uint32Array(l),i=new Uint16Array(l),function t(e,o){let s=e/4,a=e/2,l=!!o.count,u=o.boundingData;for(let t=0;t<6;t++)n[s+t]=u[t];if(l){let t=o.offset,n=o.count;return r[s+6]=t,i[a+14]=n,i[a+15]=65535,e+32}{let n;let i=o.left,a=o.right,l=o.splitAxis;if((n=t(e+32,i))/4>4294967296)throw Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return r[s+6]=n/4,n=t(n,a),r[s+7]=l,n}}(0,e),s.push(l)}return s}(t,e),!t.boundingBox&&e.setBoundingBox&&(t.boundingBox=this.getBoundingBox(new c.Box3))),this.geometry=t}refit(t=null){let e,n,r,i;t&&Array.isArray(t)&&(t=new Set(t));let o=this.geometry,s=o.index.array,a=o.attributes.position,l=0,u=this._roots;for(let o=0,c=u.length;o<c;o++)e=u[o],n=new Uint32Array(e),r=new Uint16Array(e),i=new Float32Array(e),function e(o,l,u=!1){let c=2*o;if(65535===r[c+15]){let t=n[o+6],e=r[c+14],l=1/0,u=1/0,d=1/0,f=-1/0,p=-1/0,h=-1/0;for(let n=3*t,r=3*(t+e);n<r;n++){let t=s[n],e=a.getX(t),r=a.getY(t),i=a.getZ(t);e<l&&(l=e),e>f&&(f=e),r<u&&(u=r),r>p&&(p=r),i<d&&(d=i),i>h&&(h=i)}return(i[o+0]!==l||i[o+1]!==u||i[o+2]!==d||i[o+3]!==f||i[o+4]!==p||i[o+5]!==h)&&(i[o+0]=l,i[o+1]=u,i[o+2]=d,i[o+3]=f,i[o+4]=p,i[o+5]=h,!0)}{let r=o+8,s=n[o+6],a=u,c=!1,d=!1;t?a||(c=t.has(r+l),d=t.has(s+l),a=!c&&!d):(c=!0,d=!0);let f=a||c,p=a||d,h=!1;f&&(h=e(r,l,a));let y=!1;p&&(y=e(s,l,a));let m=h||y;if(m)for(let t=0;t<3;t++){let e=r+t,n=s+t,a=i[e],l=i[e+3],u=i[n],c=i[n+3];i[o+t]=a<u?a:u,i[o+t+3]=l>c?l:c}return m}}(0,l),l+=e.byteLength}traverse(t,e=0){let n=this._roots[e],r=new Uint32Array(n),i=new Uint16Array(n);!function e(o,s=0){let a=2*o,l=65535===i[a+15];if(l){let e=r[o+6],u=i[a+14];t(s,l,new Float32Array(n,4*o,6),e,u)}else{let i=r[o+6],a=r[o+7];t(s,l,new Float32Array(n,4*o,6),a)||(e(o+8,s+1),e(i,s+1))}}(0)}raycast(t,e=c.FrontSide){let n=this._roots,r=this.geometry,a=[],l=e.isMaterial,u=Array.isArray(e),d=r.groups,f=l?e.side:e;for(let l=0,c=n.length;l<c;l++){let c=u?e[d[l].materialIndex].side:f,p=a.length;if(W(n[l]),!function t(e,n,r,a,l){let u=2*e,c=i,d=o,f=s;if(X(u,d))!function(t,e,n,r,i,o){for(let s=r,a=r+i;s<a;s++)w(t,e,n,s,o)}(n,r,a,f[e+6],d[u+14],l);else{let i=e+8;Y(i,c,a,R)&&t(i,n,r,a,l);let o=f[e+6];Y(o,c,a,R)&&t(o,n,r,a,l)}}(0,r,c,t,a),$(),u){let t=d[l].materialIndex;for(let e=p,n=a.length;e<n;e++)a[e].face.materialIndex=t}}return a}raycastFirst(t,e=c.FrontSide){let n=this._roots,r=this.geometry,a=e.isMaterial,l=Array.isArray(e),u=null,d=r.groups,f=a?e.side:e;for(let a=0,c=n.length;a<c;a++){let c=l?e[d[a].materialIndex].side:f;W(n[a]);let p=function t(e,n,r,a){let l=2*e,u=i,c=o,d=s;if(X(l,c))return function(t,e,n,r,i){let o=1/0,s=null;for(let a=r,l=r+i;a<l;a++){let r=w(t,e,n,a);r&&r.distance<o&&(s=r,o=r.distance)}return s}(n,r,a,d[e+6],c[l+14]);{let i,o;let s=d[e+7],l=N[s],c=a.direction[l]>=0;c?(i=e+8,o=d[e+6]):(i=d[e+6],o=e+8);let f=Y(i,u,a,R)?t(i,n,r,a):null;if(f){let t=f.point[l];if(c?t<=u[o+s]:t>=u[o+s+3])return f}let p=Y(o,u,a,R)?t(o,n,r,a):null;return f&&p?f.distance<=p.distance?f:p:f||p||null}}(0,r,c,t);$(),null!=p&&(null==u||p.distance<u.distance)&&(u=p,l&&(p.face.materialIndex=d[a].materialIndex))}return u}intersectsGeometry(t,e){let n=this.geometry,r=!1;for(let i of this._roots)if(W(i),r=G(0,n,t,e),$(),r)break;return r}shapecast(t,e,n){let r=this.geometry;if(t instanceof Function){if(e){let t=e;e=(e,n,r,i)=>{let o=3*n;return t(e,o,o+1,o+2,r,i)}}t={boundsTraverseOrder:n,intersectsBounds:t,intersectsTriangle:e,intersectsRange:null},console.warn("MeshBVH: Shapecast function signature has changed and now takes an object of callbacks as a second argument. See docs for new signature.")}let i=tu.getPrimitive(),{boundsTraverseOrder:o,intersectsBounds:s,intersectsRange:a,intersectsTriangle:l}=t;if(a&&l){let t=a;a=(e,n,o,s,a)=>!!t(e,n,o,s,a)||H(e,n,r,l,o,s,i)}else a||(a=l?(t,e,n,o)=>H(t,e,r,l,n,o,i):(t,e,n)=>n);let u=!1,c=0;for(let t of this._roots){if(W(t),u=Z(0,r,s,a,o,c),$(),u)break;c+=t.byteLength}return tu.releasePrimitive(i),u}bvhcast(t,e,n){let{intersectsRanges:r,intersectsTriangles:i}=n,o=this.geometry.index,s=this.geometry.attributes.position,a=t.geometry.index,l=t.geometry.attributes.position;tt.copy(e).invert();let u=tu.getPrimitive(),c=tu.getPrimitive();if(i){function d(t,n,r,d,f,p,h,y){for(let m=r,x=r+d;m<x;m++){E(c,3*m,a,l),c.a.applyMatrix4(e),c.b.applyMatrix4(e),c.c.applyMatrix4(e),c.needsUpdate=!0;for(let e=t,r=t+n;e<r;e++)if(E(u,3*e,o,s),u.needsUpdate=!0,i(u,c,e,m,f,p,h,y))return!0}return!1}if(r){let t=r;r=function(e,n,r,i,o,s,a,l){return!!t(e,n,r,i,o,s,a,l)||d(e,n,r,i,o,s,a,l)}}else r=d}t.getBoundingBox(Q),Q.applyMatrix4(e);let f=this.shapecast({intersectsBounds:t=>Q.intersectsBox(t),intersectsRange:(e,n,i,o,s,a)=>(K.copy(a),K.applyMatrix4(tt),t.shapecast({intersectsBounds:t=>K.intersectsBox(t),intersectsRange:(t,i,a,l,u)=>r(e,n,t,i,o,s,l,u)}))});return tu.releasePrimitive(u),tu.releasePrimitive(c),f}intersectsBox(t,e){return te.set(t.min,t.max,e),te.needsUpdate=!0,this.shapecast({intersectsBounds:t=>te.intersectsBox(t),intersectsTriangle:t=>te.intersectsTriangle(t)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,n={},r={},i=0,o=1/0){t.boundingBox||t.computeBoundingBox(),te.set(t.boundingBox.min,t.boundingBox.max,e),te.needsUpdate=!0;let s=this.geometry,a=s.attributes.position,l=s.index,u=t.attributes.position,c=t.index,d=tu.getPrimitive(),f=tu.getPrimitive(),p=null,h=null;r&&(p=ts,h=ta);let y=1/0,m=null,x=null;return(tt.copy(e).invert(),tn.matrix.copy(tt),this.shapecast({boundsTraverseOrder:t=>te.distanceToBox(t),intersectsBounds:(t,e,n)=>n<y&&n<o&&(e&&(tn.min.copy(t.min),tn.max.copy(t.max),tn.needsUpdate=!0),!0),intersectsRange:(n,r)=>{if(t.boundsTree)return t.boundsTree.shapecast({boundsTraverseOrder:t=>tn.distanceToBox(t),intersectsBounds:(t,e,n)=>n<y&&n<o,intersectsRange:(t,o)=>{for(let s=3*t,g=(t+o)*3;s<g;s+=3){E(f,s,c,u),f.a.applyMatrix4(e),f.b.applyMatrix4(e),f.c.applyMatrix4(e),f.needsUpdate=!0;for(let t=3*n,e=(n+r)*3;t<e;t+=3){E(d,t,l,a),d.needsUpdate=!0;let e=d.distanceToTriangle(f,ti,p);if(e<y&&(to.copy(ti),h&&h.copy(p),y=e,m=t/3,x=s/3),e<i)return!0}}}});{let t=c?c.count:u.count;for(let o=0;o<t;o+=3){E(f,o,c,u),f.a.applyMatrix4(e),f.b.applyMatrix4(e),f.c.applyMatrix4(e),f.needsUpdate=!0;for(let t=3*n,e=(n+r)*3;t<e;t+=3){E(d,t,l,a),d.needsUpdate=!0;let e=d.distanceToTriangle(f,ti,p);if(e<y&&(to.copy(ti),h&&h.copy(p),y=e,m=t/3,x=o/3),e<i)return!0}}}}}),tu.releasePrimitive(d),tu.releasePrimitive(f),y===1/0)?null:(n.point?n.point.copy(to):n.point=to.clone(),n.distance=y,n.faceIndex=m,r&&(r.point?r.point.copy(h):r.point=h.clone(),r.point.applyMatrix4(tt),to.applyMatrix4(tt),r.distance=to.sub(r.point).length(),r.faceIndex=x),n)}closestPointToPoint(t,e={},n=0,r=1/0){let i=n*n,o=r*r,s=1/0,a=null;if(this.shapecast({boundsTraverseOrder:e=>(tr.copy(t).clamp(e.min,e.max),tr.distanceToSquared(t)),intersectsBounds:(t,e,n)=>n<s&&n<o,intersectsTriangle:(e,n)=>{e.closestPointToPoint(t,tr);let r=t.distanceToSquared(tr);return r<s&&(ti.copy(tr),s=r,a=n),r<i}}),s===1/0)return null;let l=Math.sqrt(s);return e.point?e.point.copy(ti):e.point=ti.clone(),e.distance=l,e.faceIndex=a,e}getBoundingBox(t){return t.makeEmpty(),this._roots.forEach(e=>{T(0,new Float32Array(e),tl),t.union(tl)}),t}}let td=new c.Ray,tf=new c.Matrix4,tp=c.Mesh.prototype.raycast;function th(t,e){if(this.geometry.boundsTree){if(void 0===this.material)return;tf.copy(this.matrixWorld).invert(),td.copy(t.ray).applyMatrix4(tf);let n=this.geometry.boundsTree;if(!0===t.firstHitOnly){let r=B(n.raycastFirst(td,this.material),this,t);r&&e.push(r)}else{let r=n.raycast(td,this.material);for(let n=0,i=r.length;n<i;n++){let i=B(r[n],this,t);i&&e.push(i)}}}else tp.call(this,t,e)}function ty(t){return this.boundsTree=new tc(this,t),this.boundsTree}function tm(){this.boundsTree=null}let tx=t=>t.isMesh,tg=u.forwardRef(({enabled:t=!0,firstHitOnly:e=!1,children:n,strategy:r=d,verbose:i=!1,setBoundingBox:o=!0,maxDepth:s=40,maxLeafTris:f=10,...p},h)=>{let y=u.useRef(null),m=(0,l.z)(t=>t.raycaster);return u.useImperativeHandle(h,()=>y.current,[]),u.useEffect(()=>{if(t){let t={strategy:r,verbose:i,setBoundingBox:o,maxDepth:s,maxLeafTris:f},n=y.current;return m.firstHitOnly=e,n.traverse(e=>{tx(e)&&!e.geometry.boundsTree&&e.raycast===c.Mesh.prototype.raycast&&(e.raycast=th,e.geometry.computeBoundsTree=ty,e.geometry.disposeBoundsTree=tm,e.geometry.computeBoundsTree(t))}),()=>{delete m.firstHitOnly,n.traverse(t=>{tx(t)&&t.geometry.boundsTree&&(t.geometry.disposeBoundsTree(),t.raycast=c.Mesh.prototype.raycast)})}}}),u.createElement("group",(0,a.Z)({ref:y},p),n)})}}]);